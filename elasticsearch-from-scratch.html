<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Elasticsearch From Scratch</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">R_B_prince </a></h1>
                <nav><ul>
                    <li><a href="/category/algorithm.html">Algorithm</a></li>
                    <li><a href="/category/algorithmic-trading.html">Algorithmic trading</a></li>
                    <li><a href="/category/python.html">python</a></li>
                    <li><a href="/category/software.html">Software</a></li>
                    <li class="active"><a href="/category/useful-tools.html">Useful Tools</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/elasticsearch-from-scratch.html" rel="bookmark"
           title="Permalink to Elasticsearch From Scratch">Elasticsearch From Scratch</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Sun 20 December 2015</span>

</footer><!-- /.post-info -->      <h2>0. Working at Moseeker</h2>
<p>&nbsp;&nbsp; When I started doing such an exciting and exhausting work, I had never considered we were making a huge change of our life. Nowadays, it is coming to realize our dream with the efforts building <a href="http://www.moseeker.com">Moseeker</a>. From the beginning I was playing as a developer, now I am taking part in some works related to products, more about data warehouse. After all, it is one of the biggest project in Moseeker and most important part, I think.</p>
<p>&nbsp;&nbsp; What I am doing now is develop an API to source our resumes. All is needed would be a Search Engine. Tools based on Lucene will be a decent choice as told. With the comparision of Solr and Elasticsearch (Abbreviated as ES), I chose ES to be our assistant.</p>
<h2>1. Solr or ES, that won't be a problem.</h2>
<p>&nbsp;&nbsp; While Solr and ES both perform as index tools. Each of them does have its advantages compared to the other one.</p>
<p>&nbsp;&nbsp; Here I won't spend much time explaining what is Solr or ES, you could get information at <a href="http://lucene.apache.org/solr/">Solr</a> and <a href="https://www.elastic.co/webinars/get-started-with-elasticsearch?elektra=home&amp;storm=banner">Elasticsearch</a>. I'm going to talk about the differences in every detail aspect.</p>
<p>&nbsp;&nbsp; This table is quoted from <a href="http://solr-vs-elasticsearch.com/">solr-vs-elasticsearch.com</a></p>
<table>
<thead>
<tr>
<th>Condition</th>
<th>Solr</th>
<th>ES</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data format</td>
<td>XML, CSV, json</td>
<td>json</td>
</tr>
<tr>
<td>JMX support</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Product integration</td>
<td>More</td>
<td>Less</td>
</tr>
<tr>
<td>Output</td>
<td>More</td>
<td>Json only</td>
</tr>
<tr>
<td>Data import</td>
<td>JDBC, CSV, XML, Tika, URL, Flat File</td>
<td>Rivers modules: Git, MongoDB etc.</td>
</tr>
<tr>
<td>Analyzer chain</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Multiple document types per schema</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr>
<td>Hash-based deduplication</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>DSL</td>
<td>Inflexible</td>
<td>Wide usage</td>
</tr>
<tr>
<td>Aggregations</td>
<td>facet</td>
<td>aggs</td>
</tr>
<tr>
<td>Simpleness</td>
<td>Not well</td>
<td>Very much</td>
</tr>
<tr>
<td>Field declaration</td>
<td>Required</td>
<td>Automatical</td>
</tr>
<tr>
<td>Lots of fields</td>
<td>Not well</td>
<td>Recommended</td>
</tr>
<tr>
<td>Bulk upsert velocity</td>
<td>Slow</td>
<td>Quick</td>
</tr>
</tbody>
</table>
<p>&nbsp;&nbsp; Now it is time to discuss my usage of the index tools. Our purpose is to sync the index with data in Mongo. A tool named <a href="https://github.com/mongodb-labs/mongo-connector">mongo-connector</a> is used in this step. Mongo-connector will run a thread which reads from Mongo and upsert or update to index.</p>
<p>&nbsp;&nbsp; At first, I tried to deploy the system with Solr. When running with Solr, a statement must be written in XML to declare which fields to index and to store. For a nest object, this procudure might be complicated.</p>
<p>&nbsp;&nbsp; Another big problem is time consumption. Records already in Mongo need to sync at first, bulk upsert method will be used. Because of the storage ways of Mongo, data are separated info several collections, I ought to merge records related to one main record, which seems quite time-consuming.</p>
<p>&nbsp;&nbsp; There is the third trouble that usage of memory and CPU became really high and sometimes run into out-of-memory error.</p>
<p>&nbsp;&nbsp; To deal with time and space problem, we applied a new machine. And for simple using, Solr was replaced with ES. After that, everything gets easier.</p>
<h2>2. Environment and Deployment</h2>
<h4>2.0 A metion of Solr installation.</h4>
<p>&nbsp;&nbsp; Download Solr from <a href="http://apache.fayea.com/lucene/solr/">apache solr</a> and unzip the package. You can start or stop Solr with</p>
<div class="highlight"><pre> bin/solr start -e techproducts -noprompt
 bin/solr stop -all ; rm -Rf example/techproducts/
</pre></div>


<p>&nbsp;&nbsp; To sync data from Mongo, you need create a replica set of Mongo database as follows:</p>
<div class="highlight"><pre>pkill mongod
mongod --replSet myDevReplSet
rs.initiate()
// well, some of the db need auth to local, so add one
db.grantRolesToUser(
  &quot;admin&quot;,
  [
    { role: &quot;read&quot;, db: &quot;local&quot; }
  ]
)
</pre></div>


<p>&nbsp;&nbsp; Modify <code>./server/solr/configsets/basic_configs/conf/schema.xml</code></p>
<div class="highlight"><pre>replace <span class="nt">&lt;uniqueKey&gt;</span>id<span class="nt">&lt;/uniqueKey&gt;</span> to <span class="nt">&lt;uniqueKey&gt;</span>_id<span class="nt">&lt;/uniqueKey&gt;</span>
add
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;_id&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="nt">&gt;&lt;/field&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;_ts&quot;</span> <span class="na">type=</span><span class="s">&quot;long&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="nt">&gt;&lt;/field&gt;</span>
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;ns&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;&lt;/field&gt;</span>
comment
<span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;id&quot;</span> <span class="na">type=</span><span class="s">&quot;string&quot;</span> <span class="na">indexed=</span><span class="s">&quot;true&quot;</span> <span class="na">stored=</span><span class="s">&quot;true&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span> <span class="na">multiValued=</span><span class="s">&quot;false&quot;</span> <span class="nt">&gt;&lt;/field&gt;</span>
</pre></div>


<p>&nbsp;&nbsp; Modify <code>./server/solr/configsets/sample_techproducts_configs/conf/solrconfig.xml</code>, add luke request.</p>
<div class="highlight"><pre>add <span class="nt">&lt;requestHandler</span> <span class="na">name=</span><span class="s">&quot;/admin/luke&quot;</span> <span class="na">class=</span><span class="s">&quot;solr.admin.LukeRequestHandler&quot;</span> <span class="nt">&gt;&lt;/requestHandler&gt;</span>
</pre></div>


<h4>2.1 ES Configuration.</h4>
<p>&nbsp;&nbsp; Regardless of Solr, we turn attention to deploy Elasticsearch.</p>
<p>&nbsp;&nbsp; Download ES at <a href="https://www.elastic.co/downloads/elasticsearch">the official website</a>. Unzip and run, that's all.</p>
<div class="highlight"><pre>bin/elasticsearch
</pre></div>


<p>&nbsp;&nbsp; If you want to limit the IPs who can request for ES data, change the iptables.</p>
<div class="highlight"><pre>-A INPUT -s XXX.XXX.XXX.XXX/32 -p tcp -m tcp --dport 9200 -j ACCEPT
</pre></div>


<p>&nbsp;&nbsp; ES configuration file locates at <code>./config/elasticsearch.yml</code>, you could define your application for yourself compared to the<a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.4/setup-configuration.html"> document</a></p>
<h4>2.2 Mongo connector</h4>
<p>&nbsp;&nbsp; <a href="https://github.com/mongodb-labs/mongo-connector/wiki">Mongo connector</a> is an extremely useful tool for syncing records between mongo and search engine. With the help of connector, we are able to setup a bridge from Mongo database to Index.</p>
<p>&nbsp;&nbsp; To install Mongo-connector, just use</p>
<div class="highlight"><pre>pip install mongo-connector
</pre></div>


<p>&nbsp;&nbsp; Mongo-connector starts a new thread for upserting or updating index with the change of Mongodb, with which we are able to sync data. To run the thread, run script:</p>
<div class="highlight"><pre><span class="nv">$ </span>mongo-connector -m XXX.XXX.XXX.XXX:27017 --admin-username admin --password password -n dbX.collectionX,dbX.collectionY  --auto-commit-interval<span class="o">=</span><span class="m">0</span> -d my_es_docmanager -t http://XXX.XXX.XXX.XXX:9200
</pre></div>


<p>&nbsp;&nbsp; Param <code>-m</code> points to the location of Mongodb. <code>-n</code> indicates collections you want to index. <code>-d</code> chooses a docmanager to tranform data format. Make sure that you are taking an admin account of Mongodb.</p>
<p>&nbsp;&nbsp; It is the most flexable and convenient of Mongo-connector when customizing your own docmanager. Docmanagers usually locates in</p>
<div class="highlight"><pre>XXX/python2.7/dist-packages/mongo_connector/doc_managers/
</pre></div>


<p>&nbsp;&nbsp; You can copy a <code>elastic_doc_manager.py</code> and rewrite functions in the module such as <code>upsert</code>, <code>update</code>, <code>remove</code>, <code>bulk</code> etc.</p>
<h4>2.3 Python-elasticsearch</h4>
<p>&nbsp;&nbsp; There is a python package <code>elasticsearch</code> (here we simply name it <code>pyes</code>) for us to operate es instead of sending requests directly. It is recommended to use this package cause it seems easier to control user access.</p>
<p>&nbsp;&nbsp; Installation is easy,</p>
<div class="highlight"><pre>pip install elasticsearch
</pre></div>


<p>&nbsp;&nbsp; With Clients provided by <code>pyes</code>, we create index with client <code>IndicesClient</code>, submit query request with method <code>search</code> from <code>Elasticsearch</code> class.</p>
<p>&nbsp;&nbsp; Here is an example for searching.</p>
<div class="highlight"><pre>elastic = Elasticsearch(
            hosts=[url], **kwargs.get(&#39;clientOptions&#39;, {}))
result = elastic.search(index=&#39;resume&#39;, doc_type=&#39;resume&#39;, body=json.dumps(body))
</pre></div>


<h4>2.3 Customize index configuration</h4>
<p>&nbsp;&nbsp; If you consider your elasticsearch as an online product, it is better to setup a fixed setting for the index rather than let ES make decisions. It is not a must for mappings could be added whenever you want with <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-put-mapping.html">Put mapping API</a>. Within the <code>mapping</code> option, every field could set its own properties. Here is an example:</p>
<div class="highlight"><pre>elasticsearch.indices.create(index=index,
    body = {
        &quot;mappings&quot;: {
            &quot;resume&quot;: {
                &quot;properties&quot;: {
                    &quot;info&quot;: {
                        &quot;type&quot;: &quot;nested&quot;,
                        &quot;properties&quot;: {
                            &quot;qq&quot;: {&quot;type&quot;: &quot;string&quot;}
                        }
                    },
                    &quot;mobile&quot;: {&quot;type&quot;: &quot;string&quot;}
                }
            }
        }
    }
)
</pre></div>


<p>&nbsp;&nbsp; It is worth metioning that if one of the fields is recognized as <code>date</code> automatically, documents of it must have the same format and could not be <code>null</code>. If you manually set fields type as <code>date</code> and set <code>format</code> to multiple forms, you could upsert any type you want. Read <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/date.html#date-params">Date Format</a> to learn more about field <code>date</code>.</p>
<p>&nbsp;&nbsp; With the interface, you can also set how many shards should be used for indexing. More details <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html">Here</a></p>
<h4>2.4 Bulk</h4>
<p>&nbsp;&nbsp; ES provides bulk APIs for us to operate with large mounts of documents. See <a href="https://elasticsearch-py.readthedocs.org/en/master/api.html?highlight=bulk#elasticsearch.Elasticsearch.bulk">details</a>.</p>
<h2>3. DSL queries</h2>
<p>&nbsp;&nbsp; Sending requests of <code>get</code> will obtain documents you want, but using DSL might be safer and more formal. DSL jsons are packeged in function <code>elasticsearch.search()</code>, usage as follows:</p>
<div class="highlight"><pre>elasticsearch.search(
    index=index,
    doc_type=&quot;resume&quot;,
    body={
        &quot;query&quot;: {
            &quot;match_all&quot;: {}
        }
    }
)
</pre></div>


<p>&nbsp;&nbsp; Of course you can put <code>index</code> and <code>doc_type</code> into <code>body</code> so that the query will support multi-index and multi-type. Good DSL queries could lead to any result you wish to get.</p>
<p>&nbsp;&nbsp; I am not going to write this part like a document API, instead, I am seeking for proper query from requirements externally which are about personal profiles. We assume a profile like this:</p>
<div class="highlight"><pre>{
    &quot;id&quot;: &quot;12345&quot;,
    &quot;info&quot;: {
        &quot;name&quot;: &quot;Nick&quot;,
        &quot;birthday&quot;: &quot;19881001&quot;
    },
    &quot;education&quot;: [
        {
            &quot;from&quot;: &quot;20111212&quot;,
            &quot;to&quot;: &quot;&quot;
        }
    ]
}
</pre></div>


<h4>3.1 Find proper profiles on some keywords</h4>
<p>&nbsp;&nbsp; To search profiles contains <code>java</code> and <code>android</code>, send</p>
<div class="highlight"><pre>{
    &quot;query&quot;:{
        &quot;match&quot;:{&quot;_all&quot;: &quot;java android&quot;}
    }
}
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://www.moseeker.com/">Moseeker</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://www.facebook.com/hua.chai.98">Facebook</a></li>
                            <li><a href="https://twitter.com/chaihua483">Twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'rbprince';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>